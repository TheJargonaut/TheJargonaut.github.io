<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordSense Corp.</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <h1>WordSense</h1>

    <div>
        <button id="recordingButton" onclick="toggleRecording()">ðŸŽ™ Start Recording</button>
        <button id="notifyButton" onclick="sendNotification()" disabled>Notify</button>
        <button id="toggleTranscription" onclick="toggleTranscription()">Show Transcription</button>
        <button id="realTimeNotifyButton" onclick="toggleRealTimeNotifications()" disabled>Real-time Notify</button>
        <button id="showDialogButton">What's WordSense?</button>
    </div>

    <div id="dialogBox" class="hidden">
        <span id="closeButton" class="close-button">x</span>
        <div class="header">About WordSense</div>
        <div class="body">
            <span id="text"></span><span class="cursor"></span>
        </div>
    </div>

    <div id="results" style="display:none;"></div>
    <ul id="definition"></ul>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (Notification.permission !== "granted") {
                Notification.requestPermission();
            }
        });

        // Initialize variables
        let recognition;
        let isRecording = false;
        let realTimeNotify = false;
        let lastWordTimestamp = 0;
        let definedWords = new Set();
        let wordBuffer = [];

        // Function definitions
        function stripPunctuation(word) {
            return word.toLowerCase().replace(/[\W_]+/g, "");
        }

        function toggleTranscription() {
            const resultsDiv = document.getElementById('results');
            const isHidden = resultsDiv.style.display === 'none';
            resultsDiv.style.display = isHidden ? 'block' : 'none';
            document.getElementById('toggleTranscription').textContent = isHidden ? 'Hide Transcription' : 'Show Transcription';
        }

        async function toggleRecording() {
            if (isRecording) {
                recognition.stop();
                document.getElementById("recordingButton").textContent = "ðŸŽ™ Start Recording";
            } else {
                await startListening();
                document.getElementById("recordingButton").textContent = "ðŸŽ™ Stop Recording";
            }
            isRecording = !isRecording;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const showDialogButton = document.getElementById('showDialogButton');
            const dialogBox = document.getElementById('dialogBox');
            const closeButton = document.getElementById('closeButton');
            const textElement = document.getElementById('text');

            // Define the text to be typed
            const text = 'Ever been in a meeting or interview with a pompous old prig who thinks he invented the English language? We all know that guy. "Despite the epistemological quandaries presented by the dichotomy between constructivist ontology and positivist empiricism, the confluence of post-structuralist theories and quantum mechanics beckons scholars to reevaluate the hermeneutic frameworks that underpin our understanding of intersubjective reality." What did he say? You might have just lost the job because of a pretentious wannabe Brit. And whipping out your phone to Google a word mid-interview might not be the best idea, would it? Well, WordSense was created for these very situations. In what will eventually be ported to Apple Watch, WordSense will be able to define words in the moment, to your wrist, with a double tap of your fingers on Series 9 and Ultra 2 onwards. Sneak a peek at your wrist and save yourself from looking like a dum-dum: Welcome to WordSense.';
            let index = 0;

            showDialogButton.addEventListener('click', function () {
                dialogBox.style.opacity = '1';
                dialogBox.classList.remove('hidden');
                typeText();
            });

            closeButton.addEventListener('click', function () {
                dialogBox.style.opacity = '0';
                setTimeout(() => {
                    dialogBox.classList.add('hidden');
                }, 500);
            });

            function typeText() {
                if (index < text.length) {
                    textElement.innerHTML += text.charAt(index);
                    index++;
                    setTimeout(typeText, 50);
                }
            }
        });

                // Continued JavaScript part

// ... [Previous Code] ...

async function processBufferedWords() {
    while (wordBuffer.length > 0) {
        const word = wordBuffer.shift();
        const cleanWord = stripPunctuation(word);

        // Use cleanWord for caching to avoid punctuation causing cache misses
        if (wordCache.has(cleanWord)) {
            appendToResults(word, false);
            continue;
        }

        const frequency = await fetchWordFrequency(cleanWord);

        if (frequency < 4) {
            let definition = await fetchDefinition(cleanWord);
            if (definition) {
                appendToResults(word, true);
                appendToDefinitionList(word, definition);
                if (realTimeNotify) {
                    new Notification(word, { body: definition });
                }
                // Add the cleanWord to the cache
                wordCache.add(cleanWord);
            } else {
                appendToResults(word, false);
            }
        } else {
            appendToResults(word, false);
            // Add the cleanWord to the cache even if it's not uncommon
            wordCache.add(cleanWord);
        }
    }
}

async function fetchWordFrequency(word) {
    const response = await fetch(`https://api.datamuse.com/words?sp=${word}&md=f`);
    const data = await response.json();
    return parseFloat(data[0]?.tags?.find(tag => tag.startsWith("f:"))?.substring(2) || "1000");
}

// ... [Rest of your functions] ...


        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        function sendNotification() {
            if (Date.now() - lastWordTimestamp <= 10000) {
                definedWords.forEach(word => {
                    fetchDefinition(word).then(definition => {
                        if (definition) {
                            new Notification(capitalizeFirstLetter(word), { body: definition });
                        }
                    });
                });
            }
        }

        function toggleRealTimeNotifications() {
            realTimeNotify = !realTimeNotify;
            document.getElementById("realTimeNotifyButton").textContent = realTimeNotify ? 'Disable Real-time Notify' : 'Enable Real-time Notify';
        }
    </script>

</body>

</html>

    </script>

</body>

</html>
